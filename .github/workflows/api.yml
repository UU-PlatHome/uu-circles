name: API

on:
  push:
    branches: [main, develop/production, develop/stg]
  pull_request:

jobs:
  run-linters:
    name: Run linters
    runs-on: ubuntu-latest

    steps:
      - name: Check out Git repository
        uses: actions/checkout@v2

      - name: Set up PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: "7.4"
          coverage: none
          tools: composer

      - name: Install PHP dependencies
        run: |
          composer install --prefer-dist --no-suggest --no-progress --no-ansi --no-interaction
          echo "${PWD}/vendor/bin" >> $GITHUB_PATH
        working-directory: ./api

      - name: Run linters
        uses: wearerequired/lint-action@v1
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          # Enable linters
          php_codesniffer: true

  laravel-tests:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v2
      - name: init
        run: |
          docker-compose build
          docker-compose up -d
      - name: composer install
        run: docker-compose exec -T app composer install
      - name: init link and cache
        run: docker-compose exec -T app php -r "copy('.env.example', '.env');"
      - name: Generate key
        run: docker-compose exec -T app php artisan key:generate
      - name: Directory Permissions
        run: |
          docker-compose exec -T app php artisan storage:link
          docker-compose exec -T app chmod -R 777 storage
          docker-compose exec -T app chmod -R 777 bootstrap/cache
          docker-compose exec -T app php artisan config:cache
      - name: migrate
        run: |
          docker-compose exec -T app php artisan check:db
          docker-compose up -d
          docker-compose exec -T app php artisan migrate:fresh
      - name: re migrate
        run: docker-compose exec -T app php artisan migrate:refresh --seed
      - name: Execute tests
        run: docker-compose exec -T app composer test
      - name: artisan コマンドが正しく実行されるか
        run: |
          docker-compose exec -T app php artisan cache:clear
          docker-compose exec -T app php artisan config:clear
          docker-compose exec -T app php artisan view:clear

  deploy:
    if: github.ref == 'refs/heads/develop/production'
    needs: [laravel-tests]
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v2
      - name: Deploy
        env:
          PRIVATE_KEY: ${{ secrets.XSERVER_SSH_KEY }}
          USER_NAME: ${{ secrets.XSERVER_USER_NAME }}
          HOST_NAME: ${{ secrets.XSERVER_HOST_NAME }}
        run: |
          echo "$PRIVATE_KEY" > private_key && chmod 600 private_key
          ssh -p 10022 -o StrictHostKeyChecking=no -i private_key ${USER_NAME}@${HOST_NAME} 'cd ~/uu-circles.com/public_html/api/uu-circle && git fetch -p && git reset --hard origin/develop/production && cd api && composer install && php artisan migrate --force && php artisan cache:clear && php artisan config:cache && php artisan route:clear && php artisan view:clear'
